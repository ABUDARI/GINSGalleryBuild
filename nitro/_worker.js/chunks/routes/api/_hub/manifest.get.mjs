import{f as e,j as t,p as a,c as n,o as s,k as o,$ as i,l as c,e as d,h as l}from"../../../_/nitro.mjs";import{r as u}from"../../../_/auth.mjs";import"node:async_hooks";let h;function hubDatabase(){if(e("database"),h)return h;const i=t().hub,c=a.env.DB||globalThis.__env__?.DB||globalThis.DB;if(i.remote&&i.projectUrl&&!c)return h=function(t,a){e("database");const n=s.create({baseURL:o(t,"/api/_hub/database"),method:"POST",headers:{Authorization:`Bearer ${a}`}});return{exec:async e=>n("/exec",{body:{query:e}}).catch(handleProxyError$1),dump:async()=>n("/dump").catch(handleProxyError$1),prepare(e){const t={_body:{query:e,params:[]},bind:(...a)=>({...t,_body:{query:e,params:a}}),async all(){return n("/all",{body:this._body}).catch(handleProxyError$1)},async raw(e){return n("/raw",{body:{...this._body,...e}}).catch(handleProxyError$1)},async run(){return n("/run",{body:this._body}).catch(handleProxyError$1)},async first(e){return n("/first",{body:{...this._body,colName:e}}).catch(handleProxyError$1).then((e=>e||null))}};return t},batch:e=>n("/batch",{body:e.map((e=>e._body))})}}(i.projectUrl,i.projectSecretKey||i.userToken),h;if(c)return h=c,h;throw n("Missing Cloudflare DB binding (D1)")}function handleProxyError$1(e){throw n({statusCode:e.statusCode,message:e.data?.message||e.message})}function createError(e,t,a){const n=new Error(`[unstorage] [${e}] ${t}`,a);return Error.captureStackTrace&&Error.captureStackTrace(n,createError),n}const httpDriver=e=>{const r=(t="")=>o(e.base,t.replace(/:/g,"/")),rBase=(t="")=>o(e.base,(t||"/").replace(/:/g,"/"),":"),catchFetchError=(e,t=null)=>{if(404===e?.response?.status)return t;throw e},getHeaders=(t,a)=>{const n={...a,...e.headers,...t?.headers};return t?.ttl&&!n["x-ttl"]&&(n["x-ttl"]=t.ttl+""),n};return{name:"http",options:e,hasItem:(e,t)=>i(r(e),{method:"HEAD",headers:getHeaders(t)}).then((()=>!0)).catch((e=>catchFetchError(e,!1))),getItem:async(e,t)=>await i(r(e),{headers:getHeaders(t)}).catch(catchFetchError),getItemRaw:async(e,t)=>(await i.raw(r(e),{responseType:"arrayBuffer",headers:getHeaders(t,{accept:"application/octet-stream"})}).catch(catchFetchError))._data,async getMeta(e,t){const a=await i.raw(r(e),{method:"HEAD",headers:getHeaders(t)});let n,s;const o=a.headers.get("last-modified");o&&(n=new Date(o));const c=a.headers.get("x-ttl");return c&&(s=Number.parseInt(c,10)),{status:a.status,mtime:n,ttl:s}},async setItem(e,t,a){await i(r(e),{method:"PUT",body:t,headers:getHeaders(a)})},async setItemRaw(e,t,a){await i(r(e),{method:"PUT",body:t,headers:getHeaders(a,{"content-type":"application/octet-stream"})})},async removeItem(e,t){await i(r(e),{method:"DELETE",headers:getHeaders(t)})},async getKeys(e,t){const a=await i(rBase(e),{headers:getHeaders(t)});return Array.isArray(a)?a:[]},async clear(e,t){await i(rBase(e),{method:"DELETE",headers:getHeaders(t)})}}};function getKVBinding(e="STORAGE"){return function(e){let t="[binding]";if("string"==typeof e&&(t=e,e=globalThis[t]||globalThis.__env__?.[t]),!e)throw createError("cloudflare",`Invalid binding \`${t}\`: \`${e}\``);for(const a of["get","put","delete"])if(!(a in e))throw createError("cloudflare",`Invalid binding \`${t}\`: \`${a}\` key is missing`);return e}(e)}const cloudflareKVBindingDriver=e=>{const r=(t="")=>e.base?function(...e){return e.map((e=>function(e,t=":"){return e?e.replace(/[:/\\]/g,t).replace(/^[:/\\]|[:/\\]$/g,""):""}(e))).filter(Boolean).join(":")}(e.base,t):t;async function getKeys(t=""){t=r(t);const a=getKVBinding(e.binding),n=[];let s;do{const e=await a.list({prefix:t||void 0,cursor:s});n.push(...e.keys),s=e.list_complete?void 0:e.cursor}while(s);return n.map((e=>e.name))}return{name:"cloudflare-kv-binding",options:e,getInstance:()=>getKVBinding(e.binding),async hasItem(t){t=r(t);const a=getKVBinding(e.binding);return null!==await a.get(t)},getItem(t){t=r(t);return getKVBinding(e.binding).get(t)},setItem(t,a,n){t=r(t);return getKVBinding(e.binding).put(t,a,n?{expirationTtl:n?.ttl?Math.max(n.ttl,e.minTTL??60):void 0,...n}:void 0)},removeItem(t){t=r(t);return getKVBinding(e.binding).delete(t)},getKeys:t=>getKeys(t).then((t=>t.map((t=>e.base?t.slice(e.base.length):t)))),async clear(t){const a=getKVBinding(e.binding),n=await getKeys(t);await Promise.all(n.map((e=>a.delete(e))))}}};function hubKV(){e("kv");const s=t().hub,i=a.env.KV||globalThis.__env__?.KV||globalThis.KV;if(s.remote&&s.projectUrl&&!i)return function(t,a){e("kv");return c({driver:httpDriver({base:o(t,"/api/_hub/kv/"),headers:{Authorization:`Bearer ${a}`}})})}(s.projectUrl,s.projectSecretKey||s.userToken);if(i){return c({driver:cloudflareKVBindingDriver({binding:i})})}throw n("Missing Cloudflare KV binding (KV)")}const y={};function hubVectorize(i){if(e("vectorize"),y[i])return y[i];const c=t().hub,d=`VECTORIZE_${i.toUpperCase()}`,l=a.env[d]||globalThis.__env__?.[d]||globalThis[d];if(c.remote&&c.projectUrl&&!l)return y[i]=function(t,a,n){e("vectorize");const i=s.create({baseURL:o(a,`/api/_hub/vectorize/${t}`),method:"POST",headers:{Authorization:`Bearer ${n}`}});return{insert:async e=>i("/insert",{body:{vectors:e}}).catch(handleProxyError),upsert:async e=>i("/upsert",{body:{vectors:e}}).catch(handleProxyError),query:async(e,t)=>i("/query",{body:{query:e,params:t}}).catch(handleProxyError),getByIds:async e=>i("/getByIds",{body:{ids:e}}).catch(handleProxyError),deleteByIds:async e=>i("/deleteByIds",{body:{ids:e}}).catch(handleProxyError),describe:async()=>i("/describe").catch(handleProxyError)}}(i,c.projectUrl,c.projectSecretKey||c.userToken),y[i];if(l)return y[i]=l,y[i];throw n(`Missing Cloudflare Vectorize binding (${d})`)}function handleProxyError(e){throw n({statusCode:e.statusCode,message:e.data?.message||e.message})}const b=d((async e=>{await u(e);const{version:a,cache:n,ai:s,analytics:o,browser:i,blob:c,kv:d,database:h,vectorize:y}=t().hub,[b,g,m,f]=await Promise.all([falseIfFail((()=>h&&hubDatabase().exec("PRAGMA table_list"))),falseIfFail((()=>d&&hubKV().getKeys("__check__"))),falseIfFail((()=>c&&l().list({prefix:"__check__"}))),Promise.all(Object.keys(y).map((async e=>{const t=hubVectorize(e),a=await falseIfFail((()=>t.describe()));return[e,Boolean(a)]})))]),p=Object.fromEntries(Object.entries(y).filter((([e])=>f.find((([t,a])=>t===e&&a)))));return{version:a,storage:{database:Boolean(b),kv:Array.isArray(g),blob:Array.isArray(m?.blobs),vectorize:p},features:{ai:s,analytics:o,browser:i,cache:n}}}));async function falseIfFail(e){try{const t=e();return t instanceof Promise?t.catch((()=>!1)):t}catch(e){return!1}}export{b as default};
//# sourceMappingURL=manifest.get.mjs.map
